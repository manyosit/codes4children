---
import CodeLayout from '../layouts/CodeLayout.astro';
import { getCodeBySlug } from '../data/codes';
const code = getCodeBySlug('morse')!;
const funFacts = [
  { icon: 'ğŸ†˜', text: '<strong class="text-white">SOS</strong> (â— â— â— â” â” â” â— â— â—) ist das bekannteste Morse-Signal. Es wurde 1906 als internationales Notsignal eingefÃ¼hrt.' },
  { icon: 'ğŸ“¡', text: 'Der erste Morse-Telegraf Ã¼bertrug 1844 die Nachricht <strong class="text-white">"What hath God wrought"</strong> Ã¼ber 60 km.' },
];
---
<CodeLayout code={code} funFacts={funFacts}>
  <!-- Morse Alphabet -->
  <section class="max-w-content mx-auto px-6 md:px-12 py-16">
    <div class="card-static max-w-4xl mx-auto p-8">
      <h2 class="text-sm font-semibold text-text-secondary uppercase tracking-wider mb-6 text-center">Das Morse-Alphabet</h2>
      <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-9 gap-2" id="morse-table"></div>
      <p class="text-center text-sm text-text-secondary mt-4">â— = kurz (dit) &nbsp;&nbsp; â” = lang (dah)</p>
    </div>
  </section>

  <!-- Die Geschichte dahinter -->
  <section class="bg-surface-dark py-16 md:py-20">
    <div class="max-w-content mx-auto px-6 md:px-12">
      <div class="max-w-3xl mx-auto">
        <h2 class="font-display font-bold text-2xl md:text-3xl text-white text-center mb-8">ğŸ“– Die Geschichte dahinter</h2>
        <div class="bg-white/5 backdrop-blur rounded-2xl p-8 border border-white/10">
          <p class="text-gray-300 leading-relaxed mb-4">
            Es ist das Jahr 1844. <strong class="text-white">Samuel Morse</strong> sitzt in Washington und starrt auf eine merkwÃ¼rdige Maschine aus DrÃ¤hten und Magneten. Neben ihm: ein langer Draht, der 60 Kilometer weit bis nach Baltimore fÃ¼hrt. Alle halten den Atem an.
          </p>
          <p class="text-gray-300 leading-relaxed mb-4">
            Morse drÃ¼ckt einen Hebel â€” kurz, lang, kurz, lang. Am anderen Ende des Drahtes hÃ¶rt jemand die Klicks und schreibt mit: <em class="text-white">"What hath God wrought"</em> â€” "Was hat Gott geschaffen." Es ist die allererste Telegraphen-Nachricht der Geschichte!
          </p>
          <p class="text-gray-300 leading-relaxed mb-4">
            Aber die wirklich spannende Geschichte kam spÃ¤ter: Im Jahr 1912 sank die <strong class="text-white">Titanic</strong> im eiskalten Atlantik. Der Funker hÃ¤mmerte verzweifelt das berÃ¼hmteste Morse-Signal aller Zeiten in die Nacht: <strong class="text-white">â— â— â— â” â” â” â— â— â—</strong> â€” SOS! Rettungsschiffe empfingen das Signal und eilten herbei.
          </p>
          <p class="text-gray-300 leading-relaxed">
            Ohne Morse-Code hÃ¤tten Hunderte von Menschen nicht gerettet werden kÃ¶nnen. Ein einfaches System aus Punkten und Strichen â€” und es hat die Welt verÃ¤ndert. âš¡
          </p>
        </div>
      </div>
    </div>
  </section>

  <!-- Tool -->
  <section class="py-16" style={`background: ${code.accentColor}08`}>
    <div class="max-w-3xl mx-auto px-6 md:px-12">
      <h2 class="font-display font-bold text-2xl md:text-3xl text-center mb-10">Morse-Ãœbersetzer</h2>
      <div class="card-static p-8">
        <div class="mb-6">
          <label class="block text-sm font-semibold text-text-primary mb-2">Dein Text</label>
          <input type="text" id="morse-input" placeholder="Schreibe hier..." class="tool-input" maxlength="50" />
        </div>
        <div class="flex gap-3 mb-8 flex-wrap">
          <button id="btn-to-morse" class="btn" style={`background: ${code.accentColor}`}>Ãœbersetzen</button>
          <button id="btn-play-morse" class="btn bg-secondary hover:bg-secondary-dark">â–¶ Abspielen</button>
          <button id="btn-flash-morse" class="btn bg-accent hover:bg-amber-600">ğŸ’¡ Blinken</button>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text-primary mb-2">Morse-Code</label>
          <div id="morse-output" class="tool-output text-xl text-center tracking-widest"
               style={`background: ${code.accentColor}10; border-left: 4px solid ${code.accentColor}; color: ${code.accentColor}`}>â€¦</div>
        </div>
        <div id="flash-area" class="hidden mt-6 rounded-xl h-28 flex items-center justify-center text-3xl font-semibold transition-all duration-100"
             style="background: #1E293B; color: white;">ğŸ’¡</div>
      </div>
    </div>
  </section>

  <!-- SOS -->
  <section class="max-w-content mx-auto px-6 md:px-12 py-16">
    <div class="card-static max-w-3xl mx-auto text-center p-8">
      <h2 class="font-display font-bold text-2xl mb-3">ğŸ†˜ Das berÃ¼hmteste Signal</h2>
      <p class="text-text-secondary mb-6">SOS â€” das internationale Notsignal:</p>
      <div class="rounded-xl p-6 mb-4" style={`background: ${code.accentColorLight}`}>
        <p class="text-3xl font-mono font-bold tracking-widest" style={`color: ${code.accentColor}`}>â— â— â—&nbsp;&nbsp;â” â” â”&nbsp;&nbsp;â— â— â—</p>
        <p class="text-sm text-text-secondary mt-2">drei kurz â€” drei lang â€” drei kurz</p>
      </div>
    </div>
  </section>

  <script define:vars={{ accentColor: code.accentColor, accentColorLight: code.accentColorLight }}>
    const MORSE = {
      'A':'.-','B':'-...','C':'-.-.','D':'-..','E':'.','F':'..-.','G':'--.','H':'....','I':'..','J':'.---',
      'K':'-.-','L':'.-..','M':'--','N':'-.','O':'---','P':'.--.','Q':'--.-','R':'.-.','S':'...','T':'-',
      'U':'..-','V':'...-','W':'.--','X':'-..-','Y':'-.--','Z':'--..','0':'-----','1':'.----','2':'..---',
      '3':'...--','4':'....-','5':'.....','6':'-....','7':'--...','8':'---..','9':'----.'
    };

    const table = document.getElementById('morse-table');
    Object.entries(MORSE).forEach(([letter, c]) => {
      const visual = c.replace(/\./g, 'â—').replace(/-/g, 'â”');
      table.innerHTML += `<div class="rounded-xl p-3 text-center" style="background:${accentColorLight}">
        <div class="text-lg font-bold text-text-primary">${letter}</div>
        <div class="text-sm tracking-wider font-mono" style="color:${accentColor}">${visual}</div>
      </div>`;
    });

    function textToMorse(text) {
      return text.toUpperCase().split('').map(c => {
        if (c === ' ') return ' / ';
        const m = MORSE[c];
        return m ? m.replace(/\./g, 'â—').replace(/-/g, 'â”') : '';
      }).join(' ');
    }
    function textToMorseRaw(text) {
      return text.toUpperCase().split('').map(c => {
        if (c === ' ') return '/';
        return MORSE[c] || '';
      }).join(' ');
    }

    const input = document.getElementById('morse-input');
    const output = document.getElementById('morse-output');

    document.getElementById('btn-to-morse').addEventListener('click', () => {
      output.textContent = textToMorse(input.value) || 'â€¦';
    });

    document.getElementById('btn-play-morse').addEventListener('click', async () => {
      const raw = textToMorseRaw(input.value);
      if (!raw) return;
      const ctx = new AudioContext();
      let time = ctx.currentTime;
      const dot = 0.1, dash = 0.3, gap = 0.1, letterGap = 0.3, wordGap = 0.7;
      for (const char of raw) {
        if (char === '.' || char === '-') {
          const osc = ctx.createOscillator();
          osc.connect(ctx.destination);
          osc.frequency.value = 600;
          osc.start(time);
          osc.stop(time + (char === '.' ? dot : dash));
          time += (char === '.' ? dot : dash) + gap;
        } else if (char === '/') { time += wordGap; }
        else if (char === ' ') { time += letterGap; }
      }
    });

    document.getElementById('btn-flash-morse').addEventListener('click', async () => {
      const raw = textToMorseRaw(input.value);
      if (!raw) return;
      const flash = document.getElementById('flash-area');
      flash.classList.remove('hidden');
      const dot = 150, dash = 450, gap = 150, letterGap = 350, wordGap = 700;
      for (const char of raw) {
        if (char === '.' || char === '-') {
          flash.style.background = '#FFCC00';
          flash.textContent = 'âœ¨';
          await new Promise(r => setTimeout(r, char === '.' ? dot : dash));
          flash.style.background = '#1E293B';
          flash.textContent = 'ğŸ’¡';
          await new Promise(r => setTimeout(r, gap));
        } else if (char === '/') { await new Promise(r => setTimeout(r, wordGap)); }
        else if (char === ' ') { await new Promise(r => setTimeout(r, letterGap)); }
      }
    });
  </script>
</CodeLayout>
