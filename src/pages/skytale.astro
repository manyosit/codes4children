---
import CodeLayout from '../layouts/CodeLayout.astro';
import { getCodeBySlug } from '../data/codes';
const code = getCodeBySlug('skytale')!;
const funFacts = [
  { icon: 'âš”ï¸', text: 'Die <strong class="text-white">Spartaner</strong> benutzten die Skytale schon vor Ã¼ber 2.500 Jahren im Krieg.' },
  { icon: 'ğŸ“¦', text: 'Du kannst eine Skytale <strong class="text-white">ganz einfach nachbauen</strong> â€” mit einem Besenstiel und einem Papierstreifen!' },
];
---
<CodeLayout code={code} funFacts={funFacts}>
  <!-- Steps -->
  <section class="max-w-content mx-auto px-6 md:px-12 py-16">
    <div class="card-static max-w-3xl mx-auto p-8">
      <h2 class="font-display font-bold text-2xl mb-6">So funktioniert's</h2>
      <div class="space-y-4">
        {[
          { num: '1', text: 'Wickle einen Papierstreifen spiralfÃ¶rmig um einen Stock.', color: code.accentColor },
          { num: '2', text: 'Schreibe deine Nachricht quer Ã¼ber den Streifen.', color: '#6366F1' },
          { num: '3', text: 'Abgewickelt sieht die Nachricht aus wie Buchstabensalat.', color: '#3B82F6' },
          { num: '4', text: 'Nur wer einen Stock gleicher Dicke hat, kann die Nachricht lesen.', color: '#10B981' },
        ].map(step => (
          <div class="flex items-start gap-4 rounded-xl p-5" style={`background: ${step.color}10`}>
            <span class="text-sm font-bold text-white w-8 h-8 rounded-full flex items-center justify-center shrink-0" style={`background: ${step.color}`}>{step.num}</span>
            <p class="text-text-secondary">{step.text}</p>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- Tool -->
  <section class="py-16" style={`background: ${code.accentColor}08`}>
    <div class="max-w-3xl mx-auto px-6 md:px-12">
      <h2 class="font-display font-bold text-2xl md:text-3xl text-center mb-10">Skytale-Simulator</h2>
      <div class="card-static p-8">
        <div class="mb-6">
          <label class="block text-sm font-semibold text-text-primary mb-2">Deine Nachricht</label>
          <input type="text" id="skytale-input" placeholder="Schreibe hier..." class="tool-input" maxlength="60" />
        </div>
        <div class="mb-8">
          <label class="block text-sm font-semibold text-text-primary mb-2">
            Stockbreite: <span id="cols-display" style={`color: ${code.accentColor}`}>4</span>
          </label>
          <input type="range" id="skytale-cols" min="2" max="10" value="4" style={`accent-color: ${code.accentColor}`} />
        </div>

        <div class="segmented-control mb-8">
          <button id="btn-encrypt-sky" class="active">VerschlÃ¼sseln</button>
          <button id="btn-decrypt-sky">EntschlÃ¼sseln</button>
        </div>

        <div class="mb-6">
          <label class="block text-sm font-semibold text-text-secondary mb-2">Auf dem Stock</label>
          <div id="skytale-grid" class="bg-gray-50 rounded-xl p-4 flex flex-wrap gap-1 justify-center min-h-[60px]"></div>
        </div>
        <div>
          <label class="block text-sm font-semibold text-text-secondary mb-2">Ergebnis</label>
          <div id="skytale-output" class="tool-output text-xl font-semibold text-center"
               style={`background: ${code.accentColor}10; border-left: 4px solid ${code.accentColor}; color: ${code.accentColor}`}>â€¦</div>
        </div>
      </div>
    </div>
  </section>

  <!-- DIY -->
  <section class="max-w-content mx-auto px-6 md:px-12 py-16">
    <div class="card-static max-w-3xl mx-auto p-8">
      <h2 class="font-display font-bold text-2xl mb-6">Bastle deine eigene Skytale</h2>
      <div class="space-y-3 text-text-secondary">
        <p>ğŸ“¦ <strong class="text-text-primary">Du brauchst:</strong> Einen runden Stock und einen langen Papierstreifen</p>
        <p>âœ‚ï¸ Schneide einen Streifen (ca. 2 cm breit, 30 cm lang)</p>
        <p>ğŸ”„ Wickle ihn eng um den Stock</p>
        <p>âœï¸ Schreibe deine Nachricht quer Ã¼ber die Windungen</p>
        <p>ğŸ Schicke den Streifen an einen Freund â€” nur mit dem gleichen Stock lesbar!</p>
      </div>
    </div>
  </section>

  <script define:vars={{ accentColor: code.accentColor }}>
    const input = document.getElementById('skytale-input');
    const colsSlider = document.getElementById('skytale-cols');
    const colsDisplay = document.getElementById('cols-display');
    const grid = document.getElementById('skytale-grid');
    const output = document.getElementById('skytale-output');
    const btnEncrypt = document.getElementById('btn-encrypt-sky');
    const btnDecrypt = document.getElementById('btn-decrypt-sky');

    colsSlider.addEventListener('input', () => { colsDisplay.textContent = colsSlider.value; });

    const rowColors = ['#8B5CF610','#6366F110','#3B82F610','#10B98110','#F59E0B10','#EC489910','#F9731610'];

    function encrypt(text, cols) {
      const clean = text.toUpperCase().replace(/[^A-ZÃ„Ã–ÃœÃŸ ]/g, '');
      const rows = Math.ceil(clean.length / cols);
      const padded = clean.padEnd(rows * cols, 'Â·');
      const g = [];
      for (let r = 0; r < rows; r++) g.push(padded.slice(r * cols, (r+1) * cols).split(''));
      let result = '';
      for (let c = 0; c < cols; c++) for (let r = 0; r < rows; r++) result += g[r][c];
      return { grid: g, result };
    }

    function decrypt(text, cols) {
      const clean = text.toUpperCase();
      const rows = Math.ceil(clean.length / cols);
      const padded = clean.padEnd(rows * cols, 'Â·');
      const g = Array.from({length: rows}, () => Array(cols).fill('Â·'));
      let idx = 0;
      for (let c = 0; c < cols; c++) for (let r = 0; r < rows; r++) g[r][c] = padded[idx++] || 'Â·';
      let result = '';
      for (let r = 0; r < rows; r++) result += g[r].join('');
      return { grid: g, result: result.replace(/Â·/g, '').trim() };
    }

    function showGrid(g, cols) {
      grid.style.cssText = `display:grid;grid-template-columns:repeat(${cols},1fr);max-width:${cols*3.5}rem;margin:0 auto;`;
      grid.innerHTML = g.map((row, ri) =>
        row.map(c => `<div class="rounded-lg p-2 text-center font-mono font-semibold text-sm" style="background:${rowColors[ri % rowColors.length]}">${c}</div>`).join('')
      ).join('');
    }

    let mode = 'encrypt';
    btnEncrypt.addEventListener('click', () => {
      mode = 'encrypt';
      btnEncrypt.classList.add('active');
      btnDecrypt.classList.remove('active');
      doTransform();
    });
    btnDecrypt.addEventListener('click', () => {
      mode = 'decrypt';
      btnDecrypt.classList.add('active');
      btnEncrypt.classList.remove('active');
      doTransform();
    });

    function doTransform() {
      const cols = parseInt(colsSlider.value);
      const fn = mode === 'encrypt' ? encrypt : decrypt;
      const { grid: g, result } = fn(input.value, cols);
      showGrid(g, cols);
      output.textContent = result;
    }
  </script>
</CodeLayout>
